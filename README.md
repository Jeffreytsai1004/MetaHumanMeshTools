# MetaHuman Mesh Tools

![Logo](https://github.com/Jeffreytsai1004/MetaHumanMeshTools/blob/main/MetaHumanMeshToolsIcon512.jpg)

## 介绍

下面描述了使用虚幻引擎导出、编辑和重新导入 MetaHuman 网格的工作流程。

所有这些注释均来自个人经验，它们所依赖的过程可能会发生变化。 本指南假定您熟悉使用 Unreal、MetaHumans、Blender 和骨架网格物体。

该存储库还包含一个 Unreal 插件，可用于导出和导入 MetaHuman 网格，以及一个 Blender 插件，用于将正确版本的面部网格导入 Blender。 这些的使用在下面解释。

### 安装说明

Unreal 插件需要与 Unreal Engine 一起设置 Visual Studio 的工作版本。 有关详细信息，请参阅[此页面](https://docs.unrealengine.com/5.1/en-US/setting-up-visual-studio-development-environment-for-cplusplus-projects-in-unreal-engine/) .

要为单个项目安装 Unreal 插件，请创建一个名为“Plugins”的新文件夹，并将此存储库的“Unreal Plugin”文件夹的内容复制到其中。 当您下次打开项目时，Unreal 会询问您是否应该重建插件。 选择是继续（这可能需要一分钟）。 该插件应该在您的插件设置中默认启用。

要安装 Blender 附加组件，请按照安装附加组件下[本页](https://docs.blender.org/manual/en/latest/editors/preferences/addons.html) 中的说明进行操作。 使用此存储库的“Blender Add-on”文件夹中的“import_unreal_metahuman_mesh.py”文件。

## 关于修改 MetaHumans

Unreal 中的 MetaHumans 几乎可以完全修改，只有几个值得注意的限制：
- MetaHuman 面部使用 RigLogic 进行动画处理，它将 DNAAsset 数据块添加到面部网格。 此数据无法通过编辑器修改，也无法轻易复制。 此动画数据会覆盖面部骨骼，这意味着无法更改面部的骨骼结构。 但是，可以通过将头部（或颈部）骨骼的比例设置为身体骨骼的默认姿势来缩放面部。 这将在后面更详细地描述。
Unreal已经发布了修改DNA文件的【MetaHuman DNA Calibration】(https://github.com/EpicGames/MetaHuman-DNA-Calibration)工具，所以即使是这个限制也不是绝对的。
- 面部的法线和切线逻辑依赖于存储在面部网格中的顶点颜色。 这些应该保留。
- 面部网格使用混合形状或变形目标来添加更多细节并校正面部动画期间的变形。 这些应该保留。 这些混合形状包含位置增量和法线增量。 Blender 不支持具有正常调整的混合形状，并且会在导入和导出时丢失。 此限制是此处提供的工具的主要动机之一。
- 纹理可以自由更改，并可以分配给默认材质的副本。 也可以完全交换材质，但请记住，默认材质包含驱动一组反照率和法线贴图的逻辑。 这些包含皱纹的额外细节以匹配面部动画。

MetaHuman 面部的大部分动画都是由骨骼驱动的。 在不偏离原始模型及其骨骼布局太远的情况下，完全可以在 Blender 等建模软件中修改网格并保留良好的面部动画。

身体网格仅使用常规骨骼变形。 这使得使用它们类似于任何其他骨架网格物体。

## 工作流程概述

本指南描述了如何从 Unreal 中导出 MetaHuman、导入到 Blender 中、修改、重新导出和重新导入到 Unreal 中。

这个过程的大部分都可以使用 FBX 完成，但是通过 Blender 支持面部网格的变形目标使得这个过程有点麻烦。 本指南没有将变形目标作为 FBX 文件的一部分导出和导入，而是采用了将它们完全排除在外的方法。 相反，它们是在重新导入 FBX 文件后从 Unreal 中的原始 MetaHuman 面部网格复制过来的。 为实现此目的，本指南假定面部网格的拓扑结构未更改。 这允许顶点顺序在原始面部网格资产和更改版本之间保持完全相同，这使得复制变形目标相对容易和准确。

### 从虚幻中导出

对于从 Unreal 导出和重新导入到 Unreal 中，本指南仅考虑基本细节级别。 为修改后的网格重新创建 LOD 级别的方法留给读者作为练习。

MetaHumans 由面部、身体和衣服的独立网格组成。
- 面部网格可以在“MetaHumans / \<YourMetaHuman\> / Face”下找到。
- 身体网格可以在“\<Male or Female\> / \<Height\> / \<Weight\> / Body”下找到。

您需要将它们导出为 FBX 文件。 导出时，确保取消选中 LOD 级别和变形目标。

对于面部网格，您需要一个精确的副本

### 导入Blender

基本导入：

- 对于脸部和身体，照常从 FBX 导入。
- 选择“根”骨架对象并取消它的父级（alt-P），保持变换。 删除旧的父对象。 这应该只留下骨架和一个子网格。 请注意，面部和身体的骨架不同，必须同时保留。

对于面部几何：

- 移除导入的面网格，但保留骨架。
- 导入 Unreal MetaHuman Mesh (.json) 文件。
- 为骨架下的新面网格添加一个骨架修改器，指向它的父级。

使用此设置，您已经设置为导出。 对于您的第一次尝试，建议跳过修改您的 MetaHuman 并继续从 Blender 导出。

### 在 Blender 中修改网格

以下是一些提示、注意事项和注意事项：
- 使用面部网格时，您无法更改面部骨骼。 可以缩放整个面部，但这只能应用于身体网格的骨架，其中还包含颈部和头部的骨骼。 通过调整这些骨骼的比例，头部将在 Unreal 中随之缩放。 尝试为面部网格本身设置比例会导致新郎资产的可见边界框出现问题。
   - 由于无法调整面部骨骼，因此无法移动眼睛。 眼睛周围的网格与其骨骼对齐对于动画很重要。 但是，它们可以在合理的范围内相对较好地缩放。
   - 面部的大多数其他骨骼仅通过平移进行动画处理。 这意味着它们不需要严格匹配蒙皮顶点的位置。 您可能会惊讶于在不破坏面部动画的情况下可以更改和移动多少网格。
- 不得更改面部网格的拓扑结构，以确保以后可以安全地复制变形目标。 这意味着您不能合并任何顶点、更改三角剖分或添加新部分。
   - 由于无法设置镜像修改器，因此雕刻工具是进行对称更改的快速替代方法。 雕刻确实有弄乱“自定义分割法线”的趋势。 它有助于创建网格副本以保留原始自定义法线。 您可以使用数据传输修改器将这些复制到修改后的版本。
- 身体网格的骨骼可以根据需要进行调整。 更改身体网格本身或其骨骼时，请注意围绕核心骨骼设置的辅助骨骼会设置动画以跟随其姿势。 此动画经过调整以适应当前的身体形状，并且在调整网格或骨架时可能会产生看起来不自然的变形。
   - 如前所述，身体网格及其骨架使用常规骨架网格设置。 所有标准做法均适用。
- 为避免面部和身体网格之间出现可见接缝，您需要确保它们具有匹配的顶点位置、法线和蒙皮权重。 设置修改器以将其中一些转移到您的网格可能会有所帮助。
   - 对于法线，建议创建面部和身体网格的副本，将两者合并在一起。 这可以用作数据传输修改器的来源以复制法线。 注意不要覆盖面部网格的所有法线。

### 从Blender导出

要导出，只需照常导出为 FBX。 有几个要点需要检查：
- 脸部和身体分开导出。
- 对于面部和身体，您应该只导出一个网格及其骨架。 将这些导出为您的活动选择可能会有所帮助。
- 骨架对象不应有父对象且必须命名为“root”。 如果您在同一场景中同时拥有面部和身体骨架，则它们不能具有相同的名称，因此您始终需要在导出前检查和调整名称。
- 网格应该有一个骨架修改器，指向它的父级，作为堆栈中的最后一个修改器。 在此之前的任何修改器将在导出时自动应用。

### 导入虚幻引擎

导入虚幻引擎是通过创建原始 MetaHuman 网格的副本并使用给定的 FBX 覆盖网格几何体来完成的。 您还将为整个 MetaHuman 创建蓝图的副本。
- 首先，将面部或身体网格复制到您自己的资产中。 建议将这些副本放在默认的 MetaHumans 文件夹之外，因为该文件夹的内容由 Quixel Bridge 插件管理。
- 打开副本以更改其设置
   - 在 LOD 设置下，将“LOD 数量”设置为 1，然后单击其下方的“应用更改”。
   - 在导入设置下，取消选中“更新骨架参考姿势”，选中“使用 T0 作为参考姿势”并将导入旋转设置为全 0。
   - 保存资产。
- 单击 Reimport Base Mesh 并选择包含调整后的 MetaHuman 网格的 FBX 文件。
   - 此步骤不应提示任何材料分配问题。 如果出现任何问题，请根据材质插槽下的“插槽名称”检查导出的材质名称。 重新创建网格副本资产可能比尝试手动修复材质分配更快。
   - 新的 MetaHuman 网格应该具有与原始网格相同的 Verts 数量，但骨骼影响可能会有所不同。
   - 新导入的网格尚未应用变形目标，但资产查看器中的这些显示不会立即更新。 重新打开窗口显示他们现在不见了。
  
对于身体网格，您已经完成了。 对于面部网格，变形目标仍然需要从原始的 MetaHuman 网格传输。
- 右键单击您的新面部网格资产并选择“脚本化资产操作/MetaHuman 网格工具/面部变形目标复制”。 将打开一个对话窗口。
- 将原始的 MetaHuman 面部网格设置为源网格，然后单击确定。
- 脸部现在应该已经完全准备好，并且应该像原来的那样动画。
   - 如果网格资产中的顶点数量发生变化，则变形目标的复制可能会失败。 这可能是由于顶点位置的微小差异而发生的，这可能导致重叠顶点的不同合并。 如果失败，则会在输出日志中打印一条警告。
   - 通过闭上超人的眼睛来快速检查变形目标是否有效。 睁眼时眼睑向后折叠的线条在闭眼时应该消失。
  
接下来，您将需要创建您自己的 MetaHuman 蓝图副本以将您的网格分配给它。
- 将蓝图从 'MetaHumans / \<YourMetaHuman\> / BP_\<YourMetaHuman\>' 复制到您自己的资产中。 同样，建议将此副本放在默认的 MetaHumans 文件夹之外。
- 打开蓝图并找到组件中列出的身体或面部。 只需将您的网格指定为其“骨架网格资产”，保存并编译。

Grooms，头发的资产，绑定到面部几何体。 如果您更改面部，则需要创建新郎绑定资产的副本。
- 导航到您使用的每个Groom组件，然后单击绑定资产下方的浏览按钮以选择资产文件。 在 MetaHumans 文件夹外创建另一个副本。
- 打开新的绑定资产，将原始的 MetaHuman 面部网格指定为“源骨骼网格”，并将您自己的面部网格指定为“目标骨骼网格”
- 在你的 MetaHuman 蓝图中分配你的新 Bindind 资产。
